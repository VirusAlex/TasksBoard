<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</title>
<link rel="stylesheet" href="css/main.css">
<link rel="icon" type="image/svg+xml" href="icon.svg">
</head>
<body>
  <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–¥ #sidebar -->
  <button id="sidebar-toggle" class="sidebar-toggle">‚ò∞</button>

  <div id="sidebar" class="sidebar">
    <h2>–î–æ—Å–∫–∏</h2>
    <div id="static-menu">
      <div id="calendar-view" class="calendar-item">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    </div>
    <ul id="boards"></ul>
    <button id="add-board-btn" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å–∫—É</button>
    <div class="sidebar-buttons">
      <button id="storage-settings-btn" class="secondary-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</button>
      <button id="export-btn" class="secondary-btn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="import-btn" class="secondary-btn">üì• –ò–º–ø–æ—Ä—Ç</button>
      <input type="file" id="import-file" accept=".json" style="display: none;">
    </div>
  </div>

  <div id="main">
    <div class="main-header">
      <h2 id="board-title"></h2>
      <button id="theme-toggle"><span></span></button>
    </div>

    <div class="main-content">

      <div id="board-view">
        <button id="add-column-btn" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</button>
        <div id="columns"></div>
      </div>

      <div id="calendar-view-content" style="display: none;">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="icon-button" id="prev-month">‚óÄ</button>
            <h3 id="current-month"></h3>
            <button class="icon-button" id="next-month">‚ñ∂</button>
          </div>
        </div>

        <div class="calendar-container">
          <div class="main-calendar-wrapper">
            <div class="main-calendar">
              <div class="calendar-grid"></div>
            </div>
          </div>

          <div class="mini-calendars">
            <div class="mini-calendar prev-month">
              <h4 style="text-align: center;"></h4>
              <div class="calendar-grid"></div>
            </div>
            <div class="mini-calendar next-month">
              <h4 style="text-align: center;"></h4>
              <div class="calendar-grid"></div>
            </div>
          </div>
        </div>
      </div>

      <dialog id="column-dialog" class="custom-dialog">
        <form method="dialog">
          <div class="dialog-header">
            <h3></h3>
          </div>

          <div class="form-group">
            <label for="column-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏</label>
            <input type="text" id="column-name" required>
          </div>

          <div class="dialog-buttons">
            <div class="left-buttons">
              <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="right-buttons">
              <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit"></button>
            </div>
          </div>
        </form>
      </dialog>

      <dialog id="task-dialog" class="custom-dialog">
        <form method="dialog">
          <div class="dialog-header">
            <h3></h3>
            <div class="dialog-breadcrumbs"></div>
          </div>

          <div class="form-group">
            <label for="task-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" id="task-title" required>
          </div>

          <div class="form-group">
            <label for="task-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <div class="description-controls">
              <button type="button" class="icon-button" id="insert-link-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
            </div>
            <div class="description-container">
              <div class="line-numbers"></div>
              <textarea id="task-description" rows="3"></textarea>
            </div>
          </div>

          <div class="form-group checkbox">
            <input type="checkbox" id="task-info">
            <label for="task-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (–±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)</label>
          </div>

          <div class="form-group checkbox">
            <input type="checkbox" id="task-repeat">
            <label for="task-repeat">–ü–æ–≤—Ç–æ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</label>
          </div>

          <div class="reset-time-group" style="display: none;">
            <div class="reset-time-controls">
              <label for="reset-time">–í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞:</label>
              <div class="time-input-group">
                <input type="time" id="reset-time">
                <button type="button" class="clear-time-btn" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º—è">√ó</button>
              </div>
            </div>
            <small>–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Å–±—Ä–æ—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è</small>
          </div>

          <div class="form-group checkbox" id="deadline-group">
            <input type="checkbox" id="task-deadline-enabled">
            <label for="task-deadline-enabled">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω</label>
          </div>

          <div class="form-group" id="deadline-inputs" style="display: none;">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–µ–¥–ª–∞–π–Ω–∞:</label>
            <div style="display: flex; gap: 10px;">
              <input type="date" id="deadline-date" style="flex: 1;">
              <input type="time" id="deadline-time" style="width: 120px;">
            </div>
          </div>


          <div class="color-picker-group">
            <label class="color-picker-label">–¶–≤–µ—Ç –∑–∞–¥–∞—á–∏</label>
            <div class="color-options" id="task-colors">
              <div class="color-option" style="background-color: #f1c40f" data-color="#f1c40f"></div>
              <div class="color-option" style="background-color: #3498db" data-color="#3498db"></div>
              <div class="color-option" style="background-color: #e74c3c" data-color="#e74c3c"></div>
              <div class="color-option" style="background-color: #2ecc71" data-color="#2ecc71"></div>
              <div class="color-option" style="background-color: #9b59b6" data-color="#9b59b6"></div>
              <div class="color-option custom">
                <input type="color" id="custom-task-color">
              </div>
              <button type="button" class="reset-color-btn" id="reset-task-color" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–≤–µ—Ç">‚Ü∫</button>
            </div>
          </div>

          <div class="color-picker-group" id="done-color-group" style="display: none;">
            <label class="color-picker-label">–¶–≤–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏</label>
            <div class="color-options" id="done-colors">
              <div class="color-option" style="background-color: #2ecc71" data-color="#2ecc71"></div>
              <div class="color-option" style="background-color: #27ae60" data-color="#27ae60"></div>
              <div class="color-option" style="background-color: #16a085" data-color="#16a085"></div>
              <div class="color-option custom">
                <input type="color" id="custom-done-color">
              </div>
              <button type="button" class="reset-color-btn" id="reset-done-color" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–≤–µ—Ç">‚Ü∫</button>
            </div>
          </div>


          <div class="dialog-buttons">
            <div class="left-buttons">
              <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="right-buttons">
              <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit"></button>
            </div>
          </div>
        </form>
      </dialog>

      <dialog id="board-dialog" class="custom-dialog">
        <form method="dialog">
          <div class="dialog-header">
            <h3></h3>
          </div>

          <div class="form-group">
            <label for="board-name">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏</label>
            <input type="text" id="board-name" required>
          </div>

          <div class="dialog-buttons">
            <div class="left-buttons">
              <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="right-buttons">
              <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit"></button>
            </div>
          </div>
        </form>
      </dialog>

      <dialog id="confirm-dialog" class="custom-dialog">
        <form method="dialog">
          <div class="dialog-header">
            <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
          </div>

          <div class="form-group">
            <p id="confirm-message"></p>
          </div>

          <div class="dialog-buttons">
            <div class="right-buttons">
              <button type="button" class="secondary" onclick="this.closest('dialog').close('cancel')">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="danger" value="confirm">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </form>
      </dialog>

      <dialog id="link-dialog" class="custom-dialog">
        <form method="dialog">
          <div class="dialog-header">
            <h3>–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</h3>
          </div>

          <div class="form-group">
            <label for="link-url">URL</label>
            <input type="url" id="link-url" required placeholder="https://">
          </div>

          <div class="form-group">
            <label for="link-text">–¢–∫—Å—Ç —Å—Å—ã–ª–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="text" id="link-text" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç">
          </div>

          <div class="dialog-buttons">
            <div class="right-buttons">
              <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit">–í—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </form>
      </dialog>

      <!-- –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ -->
  <dialog id="storage-settings-dialog" class="custom-dialog">
    <form method="dialog">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h2>
      
      <div class="settings-group">
        <label>
          <input type="radio" name="storage-type" value="localStorage">
          LocalStorage
        </label>
        <p class="description">–ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ ~5MB.</p>
        
        <label>
          <input type="radio" name="storage-type" value="indexedDB">
          IndexedDB
        </label>
        <p class="description">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞, –ª—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.</p>
        
        <label>
          <input type="radio" name="storage-type" value="server">
          –°–µ—Ä–≤–µ—Ä
        </label>
        <p class="description">–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ.</p>
      </div>

      <div id="server-settings" style="display: none;">
        <div class="form-group">
          <label for="server-url">URL —Å–µ—Ä–≤–µ—Ä–∞:</label>
          <input type="url" id="server-url" placeholder="https://your-server.com/api">
        </div>
        <div class="form-group">
          <label for="server-token">–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞:</label>
          <input type="password" autocomplete="off" id="server-token">
        </div>
      </div>

      <div class="dialog-buttons">
        <div class="left-buttons"></div>
        <div class="right-buttons">
          <button type="submit" value="cancel" class="secondary">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" value="confirm" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ -->
  <dialog id="storage-confirm-dialog" class="custom-dialog">
    <form method="dialog">
      <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
      <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.</p>
      <p>–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
      <div class="dialog-buttons">
        <div class="left-buttons"></div>
        <div class="right-buttons">
          <button type="submit" value="cancel" class="secondary">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" value="confirm" class="primary">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>
    </form>
  </dialog>

    </div>
    
  </div>

  <script type="module">
    import { initApp } from './js/app.js';
    import { StorageType } from './js/data/dataProvider.js';

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initializeApp() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        const savedConfig = JSON.parse(localStorage.getItem('storage-config') || '{"type":"localStorage"}');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        await initApp(savedConfig);
      } catch (error) {
        console.error('Failed to initialize app:', error);
        alert('Failed to initialize application. Please check your connection and reload the page.');
      }
    }

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
    const storageDialog = document.getElementById('storage-settings-dialog');
    const storageConfirmDialog = document.getElementById('storage-confirm-dialog');
    const storageForm = storageDialog.querySelector('form');
    const serverSettings = document.getElementById('server-settings');
    const radioButtons = storageForm.querySelectorAll('input[name="storage-type"]');
    const serverUrl = document.getElementById('server-url');
    const serverToken = document.getElementById('server-token');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const savedConfig = JSON.parse(localStorage.getItem('storage-config') || '{"type":"localStorage"}');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    radioButtons.forEach(radio => {
      radio.addEventListener('change', (e) => {
        serverSettings.style.display = e.target.value === StorageType.SERVER ? 'block' : 'none';
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById('storage-settings-btn').addEventListener('click', () => {
      document.querySelector(`input[value="${savedConfig.type}"]`).checked = true;
      if (savedConfig.type === StorageType.SERVER) {
        serverSettings.style.display = 'block';
        serverUrl.value = savedConfig.apiUrl || '';
        serverToken.value = savedConfig.apiToken || '';
      } else {
        serverSettings.style.display = 'none';
      }
      storageDialog.showModal();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    storageConfirmDialog.addEventListener('close', (e) => {
      if (storageConfirmDialog.returnValue === 'confirm') {
        window.location.reload();
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    storageForm.addEventListener('submit', async (e) => {
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
      e.preventDefault();
      
      // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏
      const submitButton = e.submitter;
      
      // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
      if (submitButton.value === 'cancel') {
        storageDialog.close();
        return;
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
      const selectedType = storageForm.querySelector('input[name="storage-type"]:checked').value;
      const config = { type: selectedType };

      if (selectedType === StorageType.SERVER) {
        config.apiUrl = serverUrl.value.trim();
        config.apiToken = serverToken.value.trim();

        if (!config.apiUrl || !config.apiToken) {
          alert('–î–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å URL –∏ —Ç–æ–∫–µ–Ω');
          return;
        }
      }

      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        localStorage.setItem('storage-config', JSON.stringify(config));
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        storageDialog.close();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        storageConfirmDialog.showModal();
      } catch (error) {
        console.error('Failed to initialize storage:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: ' + error.message);
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
