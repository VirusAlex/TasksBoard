<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</title>
<style>
  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è body –∏ html */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    min-height: 100vh;
    /* –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
    min-height: -webkit-fill-available;
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    display: flex;
    background: #f5f7fa;
    color: #2c3e50;
    overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ body */
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é */
  #sidebar {
    width: 250px;
    border-right: 1px solid rgba(0,0,0,0.1);
    padding: 20px;
    box-sizing: border-box;
    background: white;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: -webkit-fill-available;
    overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é */
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    padding: 20px;
    height: 100vh;
    height: -webkit-fill-available;
    overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ main */
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
  #columns {
    position: relative; /* –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ */
    display: flex;
    gap: 20px;
    overflow-x: auto;
    overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
    flex: 1;
    padding: 10px 0 20px 0;
    align-items: flex-start;
    height: calc(100% - 80px); /* –£—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: #3498db;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  button:hover {
    background: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  /* –°–ø–∏—Å–æ–∫ –¥–æ—Å–æ–∫ */
  #boards {
    list-style: none;
    padding: 0;
    margin: 0 -20px; /* –†–∞—Å—à–∏—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–∞–π–¥–±–∞—Ä–∞ */
  }
  #boards li {
    cursor: pointer;
    margin: 0;
    padding: 12px 20px;
    transition: all 0.2s ease;
    position: relative;
    border-left: 3px solid transparent;
  }
  #boards li:hover {
    background: rgba(52,152,219,0.1);
    border-left-color: rgba(52,152,219,0.5);
  }
  #boards li.selected {
    background: rgba(52,152,219,0.15);
    border-left-color: #3498db;
    font-weight: 500;
  }
  /* –ö–æ–ª–æ–Ω–∫–∏ */
  .column {
    position: relative;
    background: #f8f9fa;
    border-radius: 10px;
    min-width: 280px;
    padding: 15px;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: grab;
    user-select: none; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
  }
  .column h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #34495e;
    font-size: 16px;
  }
  .column.dragging {
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }
  .column-drop-indicator {
    width: 2px;
    height: 100%;
    background: #3498db;
    margin: 0 8px;
    border-radius: 1px;
    display: block;
    position: relative;
    pointer-events: none;
    z-index: 1000;
  }
  .column-drop-indicator::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 0;
    width: 10px;
    height: 10px;
    background: #3498db;
    border-radius: 50%;
  }
  /* –ó–∞–¥–∞—á–∏ */
  .task {
    position: relative;
    padding: 12px 15px 15px 15px;
    background: white;
    border-radius: 6px;
    margin: 8px 0;
    cursor: grab;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s ease, background-color 0.2s ease;
    border: 1px solid rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-left: 2px solid #f1c40f; /* –ñ–µ–ª—Ç—ã–π —Ü–≤–µ—Ç –¥–ª—è –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á */
  }
  .task:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .task.done {
    opacity: 0.7;
    background: #f5f5f5;
    border-left-color: #2ecc71; /* –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á */
  }
  .task.info {
    border-left-color: #3498db; /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á */
  }

   /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ */
   .color-picker-group {
    margin-top: 20px;
    padding: 0 25px 0 0;
  }

  .color-picker-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    color: #34495e;
  }

  .reset-color-btn {
    padding: 4px 8px;
    font-size: 14px;
    background: transparent;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 4px;
    cursor: pointer;
    box-shadow: none;
    color: #666;
  }

  .reset-color-btn:hover {
    background: rgba(0,0,0,0.05);
    transform: none;
    box-shadow: none;
  }

  .dark-theme .reset-color-btn {
    border-color: rgba(255,255,255,0.1);
    color: #bdc3c7;
  }

  .dark-theme .reset-color-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  .dark-theme .color-picker-label {
    color: #ecf0f1;
  }

  .color-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .color-option {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    position: relative;
    transition: transform 0.2s ease;
  }

  .color-option:hover {
    transform: scale(1.1);
  }

  .color-option.selected {
    border-color: #3498db;
  }

  .dark-theme .color-option.selected {
    border-color: #5dade2;
  }

  .color-option.custom {
    background: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%),
                linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%);
    background-size: 8px 8px;
    background-position: 0 0, 4px 4px;
  }

  .color-option input[type="color"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞—Å–∫–æ–≤ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏ */
  .task[data-custom-color] {
    background-color: var(--task-bg-color, white);
  }

  .dark-theme .task[data-custom-color] {
    background-color: var(--task-bg-color);
  }

  .task[data-custom-color].done {
    background-color: var(--task-done-bg-color, #f5f5f5);
  }

  .dark-theme .task[data-custom-color].done {
    background-color: var(--task-done-bg-color);
  }

  /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
  input[type="text"] {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 6px;
    margin: 8px 0;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  input[type="text"]:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
  }
  /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
  h2 {
    color: #2c3e50;
    font-size: 20px;
    margin-bottom: 20px;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
  body.dark-theme {
    background: #1a1a1a;
    color: #ecf0f1;
  }
  .dark-theme #sidebar {
    background: #2c3e50;
    border-right-color: rgba(255,255,255,0.1);
  }
  .dark-theme #boards li {
    background: #34495e;
    border-color: rgba(255,255,255,0.1);
    color: #ecf0f1;
  }
  .dark-theme #boards li:hover {
    background: rgba(52,152,219,0.2);
    border-left-color: rgba(52,152,219,0.6);
  }
  .dark-theme .column {
    background: #2c3e50;
  }
  .dark-theme .task {
    background: #34495e;
    border-color: rgba(255,255,255,0.1);
    color: #ecf0f1;
    border-left-color: #f39c12; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –∂–µ–ª—Ç—ã–π –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
  }
  .dark-theme .task.done {
    background: #2c3e50;
    border-left-color: #27ae60; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
  }
  .dark-theme .task.info {
    border-left-color: #2980b9; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Å–∏–Ω–∏–π –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
  }
  .dark-theme input[type="text"] {
    background: #34495e;
    border-color: rgba(255,255,255,0.1);
    color: #ecf0f1;
  }
  .dark-theme input[type="text"]:focus {
    border-color: #3498db;
  }
  /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
  #theme-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .dark-theme #theme-toggle {
    background: #34495e;
    color: #ecf0f1;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
  }
  .dark-theme ::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
  }
  .dark-theme ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ—Å–ª–µ div#columns */
  .custom-dialog {
    position: fixed;
    background: white;
    z-index: 1000;
    border: none;
    border-radius: 12px;
    min-width: 500px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    margin: auto;
    padding: 30px 40px;
  }
  .custom-dialog h3 {
    margin-top: 0;
    color: #34495e;
    font-size: 24px;
    margin-bottom: 20px;
  }
  .form-group {
    margin-bottom: 16px;
    padding: 0 25px 0 0;
  }
  .form-group label {
    display: block;
    color: #34495e;
    font-size: 16px;
    margin-bottom: 8px;
  }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 6px;
    padding: 12px;
    font-size: 16px;
  }
  .form-group textarea {
    height: 100px;
    min-height: 150px;
  }
  .dialog-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
  }
  .right-buttons {
    display: flex;
    gap: 15px;
  }
  .danger {
    background: #e74c3c;
  }
  .danger:hover {
    background: #c0392b;
  }
  .dark-theme .danger {
    background: #c0392b;
  }
  .dark-theme .danger:hover {
    background: #e74c3c;
  }
  .custom-dialog::backdrop {
    background: rgba(0,0,0,0.5);
  }
  .dark-theme .custom-dialog {
    background: #2c3e50;
    color: #ecf0f1;
  }
  .dark-theme .custom-dialog h3 {
    color: #ecf0f1;
  }
  .dark-theme .form-group label {
    color: #ecf0f1;
  }
  .dark-theme .form-group input, .dark-theme .form-group textarea {
    background: #34495e;
    border-color: rgba(255,255,255,0.2);
    color: #ecf0f1;
  }
  .dark-theme .form-group input:focus, .dark-theme .form-group textarea:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
  }
  .dark-theme button.secondary {
    background: #34495e;
    color: #ecf0f1;
  }
  .dark-theme button.secondary:hover {
    background: #2c3e50;
  }
  /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ */
  .add-btn {
    width: 100%;
    text-align: left;
    background: rgba(52,152,219,0.1);
    color: #3498db;
    margin: 8px 0;
  }
  .column .add-btn {
    margin: 8px 0 0 0;
  }
  .dark-theme .add-btn {
    background: rgba(52,152,219,0.2);
    color: #3498db;
  }
  .task-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 0;
    padding-right: 25px;    /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
  }
  .task-description {
    font-size: 0.9em;
    color: #666;
    white-space: pre-wrap;
    overflow: hidden;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  }
  .dark-theme .task-description {
    color: #bdc3c7;
  }
  .form-group.checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
  }
  .form-group.checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin: 0;
  }
  .form-group.checkbox label {
    margin: 0;
    cursor: pointer;
  }
  /* –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã –Ω–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
  .dark-theme {
    color: #ecf0f1;
  }
  .dark-theme h2, .dark-theme h3, .dark-theme label, .dark-theme .task-title {
    color: #ecf0f1;
  }
  .dark-theme .column h3 {
    color: #ecf0f1;
  }
  .dark-theme input[type="text"], .dark-theme textarea {
    background: #34495e;
    border-color: rgba(255,255,255,0.2);
    color: #ecf0f1;
  }
  .dark-theme input[type="text"]:focus, .dark-theme textarea:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
  }
  .custom-dialog form {
    margin: 0 auto;
  }
  .task-header {
    display: flex;
    align-items: flex-start;
    gap: 8px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    position: relative;
  }
  .task input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin-top: 3px;
    cursor: pointer;
  }
  .task-title {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–∏–∞–ª–æ–≥–∞ */
  .dialog-header {
    margin-bottom: 30px;
  }
  .dialog-breadcrumbs {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
  }
  .dark-theme .dialog-breadcrumbs {
    color: #bdc3c7;
  }
  .dialog-header h3 {
    margin: 0;
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤—Å—Ç–∞–≤–∫–∏ */
  .task-drop-indicator {
    height: 2px;
    background: #3498db;
    margin: 8px 0;
    border-radius: 1px;
    display: block;
    position: relative;
    pointer-events: none;
  }
  .task-drop-indicator::before {
    content: '';
    position: absolute;
    left: -5px;
    top: -4px;
    width: 10px;
    height: 10px;
    background: #3498db;
    border-radius: 50%;
  }
  .task.dragging {
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã –≤—Ä–µ–º–µ–Ω–∏ —Å–±—Ä–æ—Å–∞ */
  .reset-time-group {
    margin-top: 10px;
    margin-left: 26px;
    font-size: 14px;
  }
  .reset-time-group label {
    display: inline-block;
    margin-right: 10px;
  }
  .reset-time-group input[type="time"] {
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.1);
    margin-right: 10px;
  }
  .reset-time-group small {
    display: block;
    color: #666;
    margin-top: 4px;
  }
  .dark-theme .reset-time-group small {
    color: #bdc3c7;
  }
  .dark-theme .reset-time-group input[type="time"] {
    background: #34495e;
    border-color: rgba(255,255,255,0.2);
    color: #ecf0f1;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±—Ä–æ—Å–µ */
  .task-reset-info {
    color: #666;
    background: rgba(0,0,0,0.05);
    padding: 2px 6px;
    border-radius: 4px;
    line-height: 1.4;
    right: 8px;
    bottom: 8px;
    font-size: 11px;
    white-space: nowrap;
    margin-left: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
  }
  .dark-theme .task-reset-info {
    color: #bdc3c7;
    background: rgba(255,255,255,0.1);
  }
  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±—Ä–æ—Å–µ */
  .task-icons {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .task-repeat-icon {
    font-size: 14px;
    color: #3498db;
    line-height: 1;
    position: absolute;
    right: 8px;
    top: 8px;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(52,152,219,0.1);
    border-radius: 4px;
    padding: 3px;
  }
  .dark-theme .task-repeat-icon {
    color: #5dade2;
    background: rgba(52,152,219,0.15);
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã –≤—Ä–µ–º–µ–Ω–∏ */
  .reset-time-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }
  .time-input-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .clear-time-btn {
    padding: 2px 6px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    height: 24px;
  }
  .clear-time-btn:hover {
    background: #c0392b;
  }
  .dark-theme .clear-time-btn {
    background: #c0392b;
  }
  .dark-theme .clear-time-btn:hover {
    background: #e74c3c;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–æ—Å–∫–∏ */
  #board-title {
    cursor: pointer;
    user-select: none;
  }

  #board-title:hover {
    color: #3498db;
  }

  .dark-theme #board-title:hover {
    color: #5dade2;
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è */
  .task-done-time {
    left: 8px;
    bottom: 8px;
    color: #666;
    font-size: 11px;
    opacity: 0.8;
    text-decoration: none !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
    white-space: nowrap;
  }

  .dark-theme .task-done-time {
    color: #bdc3c7;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è */
  .sidebar-toggle {
    display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    position: fixed;
    left: 10px;
    top: 10px;
    z-index: 1000;
    padding: 8px 12px;
    font-size: 20px;
    background: #3498db;
    border-radius: 6px;
  }

  /* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
  @media (max-width: 768px) {
    .sidebar-toggle {
      display: block;
    }

    #sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      bottom: 0;
      z-index: 999;
      transition: left 0.3s ease;
    }

    #sidebar.open {
      left: 0;
    }

    /* –°–¥–≤–∏–≥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    #main {
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }

    body.sidebar-open #main {
      margin-left: 250px;
    }

    /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 998;
    }

    body.sidebar-open .sidebar-backdrop {
      display: block;
    }
  }

  .dark-theme #boards li.selected {
    background: rgba(52,152,219,0.25);
    border-left-color: #5dade2;
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏ */
  #sidebar .add-btn {
    margin: 15px 0;
    width: 100%;
    text-align: left;
    background: rgba(52,152,219,0.1);
    color: #3498db;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  #sidebar .add-btn:hover {
    background: rgba(52,152,219,0.2);
    transform: translateY(-1px);
  }

  .dark-theme #sidebar .add-btn {
    background: rgba(52,152,219,0.2);
  }

  .dark-theme #sidebar .add-btn:hover {
    background: rgba(52,152,219,0.3);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
  .description-controls {
    margin-bottom: 8px;
  }

  .icon-button {
    padding: 4px 8px;
    font-size: 16px;
    background: transparent;
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: none;
  }

  .icon-button:hover {
    background: rgba(52,152,219,0.1);
    transform: none;
    box-shadow: none;
  }

  .dark-theme .icon-button {
    border-color: rgba(255,255,255,0.1);
    color: #ecf0f1;
  }

  .dark-theme .icon-button:hover {
    background: rgba(52,152,219,0.2);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ */
  .task-description a, .task-title a {
    color: #3498db;
    text-decoration: none;
    font-family: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ–º —à—Ä–∏—Ñ—Ç –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è */
  }

  .task-description a:hover, .task-title a:hover {
    text-decoration: underline;
  }

  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ */
  .task-description a:visited, .task-title a:visited {
    color: #3498db; /* –¢–æ—Ç –∂–µ —Ü–≤–µ—Ç, —á—Ç–æ –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ */
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
  .dark-theme .task-description a,
  .dark-theme .task-title a,
  .dark-theme .task-description a:visited,
  .dark-theme .task-title a:visited {
    color: #5dade2;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–±—Ç–∞—Å–∫–æ–≤ */
  .task.subtask {
    font-size: 0.95em;
    /* background: rgba(52, 152, 219, 0.05); */
    margin: 8px 0 0 0;
  }

  .dark-theme .task.subtask {
    background: rgba(52, 152, 219, 0.1);
  }

  /* –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–∞–±—Ç–∞—Å–∫–æ–≤ */
  .task-expand-toggle {
    cursor: pointer;
    width: calc(100% + 30px); /* –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º –ª–µ–≤—ã–π –∏ –ø—Ä–∞–≤—ã–π padding */
    height: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    user-select: none;
    background: rgba(0,0,0,0.03);
    border-radius: 0 0 6px 6px;
    transition: all 0.2s ease;
    border-top: 1px solid rgba(0,0,0,0.05);
    padding: 2px 0;
    margin: 0 -15px -15px -15px; /* –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º padding —Ä–æ–¥–∏—Ç–µ–ª—è */
  }

  .task-expand-toggle:hover {
    background: rgba(0,0,0,0.05);
    color: #333;
  }

  .dark-theme .task-expand-toggle {
    color: #bdc3c7;
    background: rgba(255,255,255,0.05);
    border-top-color: rgba(255,255,255,0.1);
  }

  .dark-theme .task-expand-toggle:hover {
    background: rgba(255,255,255,0.1);
    color: #ecf0f1;
  }

  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É */
  .task-expand-toggle::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border: 2px solid currentColor;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg) translateY(-3px);
    transition: transform 0.2s ease;
  }

  .task-expand-toggle.collapsed::after {
    transform: rotate(-45deg);
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∞–±—Ç–∞—Å–∫–æ–≤ */
  .subtasks-container {
    transition: height 0.3s ease;
  }

  /* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–±—Ç–∞—Å–∫–∞ */
  .subtask-drop-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(52, 152, 219, 0.1);
    border: 2px dashed #3498db;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
  }

  .subtask-drop-indicator::after {
    content: '‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É';
    background: rgba(52, 152, 219, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
  }

  .dark-theme .subtask-drop-indicator {
    background: rgba(52, 152, 219, 0.2);
  }

  .dark-theme .subtasks-container {
    border-left-color: #5dade2;
  }

  /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ */
  .done > .task-header {
    text-decoration: line-through;
    opacity: 0.7;
  }

  /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ */
  .task-time-indicators {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: #666;
  }

  .dark-theme .task-time-indicators {
    color: #bdc3c7;
  }
  /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞, –∫–æ–≥–¥–∞ –Ω–µ—Ç —á–µ–∫–±–æ–∫—Å–∞ */
  .task.info .task-content {
    margin-left: 8px;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
  .column-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .column-header h3 {
    margin: 0;
    flex-grow: 1;
  }

  .column-stats {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
    background: rgba(0,0,0,0.05);
    padding: 4px 8px;
    border-radius: 12px;
  }

  .dark-theme .column-stats {
    color: #bdc3c7;
    background: rgba(255,255,255,0.1);
  }

  .stats-done {
    color: #27ae60;
  }

  .dark-theme .stats-done {
    color: #2ecc71;
  }

  .stats-total {
    color: #666;
  }

  .dark-theme .stats-total {
    color: #bdc3c7;
  }

</style>
</head>
<body>
  <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–≥–∞ body -->
  <button id="theme-toggle">üåô</button>

  <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–¥ #sidebar -->
  <button id="sidebar-toggle" class="sidebar-toggle">‚ò∞</button>

  <div id="sidebar" class="sidebar">
    <h2>–î–æ—Å–∫–∏</h2>
    <ul id="boards"></ul>
    <button id="add-board-btn" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å–∫—É</button>
  </div>

  <div id="main">
    <h2 id="board-title"></h2>
    <button id="add-column-btn" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</button>
    <div id="columns"></div>
    
    <dialog id="column-dialog" class="custom-dialog">
      <form method="dialog">
        <div class="dialog-header">
          <h3></h3>
        </div>
        
        <div class="form-group">
          <label for="column-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏</label>
          <input type="text" id="column-name" required>
        </div>

        <div class="dialog-buttons">
          <div class="left-buttons">
            <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="right-buttons">
            <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit"></button>
          </div>
        </div>
      </form>
    </dialog>

    <dialog id="task-dialog" class="custom-dialog">
      <form method="dialog">
        <div class="dialog-header">
          <h3></h3>
          <div class="dialog-breadcrumbs"></div>
        </div>
        
        <div class="form-group">
          <label for="task-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input type="text" id="task-title" required>
        </div>

        <div class="form-group">
          <label for="task-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <div class="description-controls">
            <button type="button" class="icon-button" onclick="insertLink()" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
          </div>
          <textarea id="task-description" rows="3"></textarea>
        </div>

        <div class="form-group checkbox">
          <input type="checkbox" id="task-info">
          <label for="task-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (–±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)</label>
        </div>

        <div class="form-group checkbox">
          <input type="checkbox" id="task-repeat">
          <label for="task-repeat">–ü–æ–≤—Ç–æ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</label>
        </div>

        <div class="reset-time-group" style="display: none;">
          <div class="reset-time-controls">
            <label for="reset-time">–í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞:</label>
            <div class="time-input-group">
              <input type="time" id="reset-time">
              <button type="button" class="clear-time-btn" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º—è">√ó</button>
            </div>
          </div>
          <small>–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Å–±—Ä–æ—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è</small>
        </div>

        
        <div class="color-picker-group">
          <label class="color-picker-label">–¶–≤–µ—Ç –∑–∞–¥–∞—á–∏</label>
          <div class="color-options" id="task-colors">
            <div class="color-option" style="background-color: #f1c40f" data-color="#f1c40f"></div>
            <div class="color-option" style="background-color: #3498db" data-color="#3498db"></div>
            <div class="color-option" style="background-color: #e74c3c" data-color="#e74c3c"></div>
            <div class="color-option" style="background-color: #2ecc71" data-color="#2ecc71"></div>
            <div class="color-option" style="background-color: #9b59b6" data-color="#9b59b6"></div>
            <div class="color-option custom">
              <input type="color" id="custom-task-color">
            </div>
            <button type="button" class="reset-color-btn" id="reset-task-color" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–≤–µ—Ç">‚Ü∫</button>
          </div>
        </div>

        <div class="color-picker-group" id="done-color-group" style="display: none;">
          <label class="color-picker-label">–¶–≤–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏</label>
          <div class="color-options" id="done-colors">
            <div class="color-option" style="background-color: #2ecc71" data-color="#2ecc71"></div>
            <div class="color-option" style="background-color: #27ae60" data-color="#27ae60"></div>
            <div class="color-option" style="background-color: #16a085" data-color="#16a085"></div>
            <div class="color-option custom">
              <input type="color" id="custom-done-color">
            </div>
            <button type="button" class="reset-color-btn" id="reset-done-color" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–≤–µ—Ç">‚Ü∫</button>
          </div>
        </div>


        <div class="dialog-buttons">
          <div class="left-buttons">
            <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="right-buttons">
            <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </div>
      </form>
    </dialog>

    <dialog id="board-dialog" class="custom-dialog">
      <form method="dialog">
        <div class="dialog-header">
          <h3></h3>
        </div>
        
        <div class="form-group">
          <label for="board-name">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏</label>
          <input type="text" id="board-name" required>
        </div>

        <div class="dialog-buttons">
          <div class="left-buttons">
            <button type="button" class="danger delete-btn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="right-buttons">
            <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit"></button>
          </div>
        </div>
      </form>
    </dialog>

    <dialog id="confirm-dialog" class="custom-dialog">
      <form method="dialog">
        <div class="dialog-header">
          <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        </div>
        
        <div class="form-group">
          <p id="confirm-message"></p>
        </div>

        <div class="dialog-buttons">
          <div class="right-buttons">
            <button type="button" class="secondary" onclick="this.closest('dialog').close('cancel')">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="danger" value="confirm">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </dialog>

    <dialog id="link-dialog" class="custom-dialog">
      <form method="dialog">
        <div class="dialog-header">
          <h3>–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</h3>
        </div>
        
        <div class="form-group">
          <label for="link-url">URL</label>
          <input type="url" id="link-url" required placeholder="https://">
        </div>

        <div class="form-group">
          <label for="link-text">–¢–∫—Å—Ç —Å—Å—ã–ª–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="text" id="link-text" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç">
        </div>

        <div class="dialog-buttons">
          <div class="right-buttons">
            <button type="button" class="secondary" onclick="this.closest('dialog').close()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit">–í—Å—Ç–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </dialog>

    
  </div>

<script>
  // –î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
  let resetTimeIntervals = new Map();

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ü–≤–µ—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const defaultTaskColors = {
    pending: '#f1c40f',
    info: '#3498db',
    done: '#2ecc71'
  };

  const darkThemeTaskColors = {
    pending: '#f39c12',
    info: '#2980b9',
    done: '#27ae60'
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö ID
  function generateId() {
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

  let data = JSON.parse(localStorage.getItem('taskBoardsData') || 'null') || {
    boards: [],
    selectedBoardId: null
  };

  const boardsEl = document.getElementById('boards');
  const addBoardBtn = document.getElementById('add-board-btn');
  const boardTitleEl = document.getElementById('board-title');
  const columnsEl = document.getElementById('columns');
  const addColumnBtn = document.getElementById('add-column-btn');
  const mainEl = document.getElementById('main');

  columnsEl.addEventListener('dragover', (e) => {
    const draggingCol = document.querySelector('.column.dragging');
    if (!draggingCol) return;
    e.preventDefault();
    e.stopPropagation();
    showColumnDropIndicator(e, draggingCol);
  });

  columnsEl.addEventListener('drop', (e) => {
    handleColumnDrop(e);
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–¥–∞—á: –µ—Å–ª–∏ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è > –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî —Å–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É
  // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ "–Ω–æ–≤—ã–π –¥–µ–Ω—å" ‚Äî —ç—Ç–æ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ (YYYY-MM-DD) –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.
  let today = new Date().toISOString().slice(0,10);
  data.boards.forEach(board => {
    board.columns.forEach(col => {
      col.tasks.forEach(task => {
        if (task.repeating && task.done && task.doneDate && task.doneDate < today) {
          task.done = false;
          task.doneDate = null;
        }
      });
    });
  });

  function saveData() {
    localStorage.setItem('taskBoardsData', JSON.stringify(data));
  }

  function renderBoardsList() {
    boardsEl.innerHTML = '';
    data.boards.forEach(board => {
      const li = document.createElement('li');
      li.textContent = board.name;
      
      if (data.selectedBoardId === board.id) {
        li.className = 'selected';
      }
      
      li.onclick = () => {
        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å selected —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        boardsEl.querySelectorAll('li').forEach(el => el.classList.remove('selected'));
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å selected –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        li.classList.add('selected');
        
        data.selectedBoardId = board.id;
        saveData();
        render();
      };

      boardsEl.appendChild(li);
    });
  }

  function getSelectedBoard() {
    return data.boards.find(b => b.id === data.selectedBoardId);
  }

  function renderBoard() {
    const board = getSelectedBoard();
    if (!board) {
      boardTitleEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é';
      columnsEl.innerHTML = '';
      return;
    }

    // –î–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ—Å–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º
    boardTitleEl.textContent = board.name;
    boardTitleEl.style.cursor = 'pointer';
    boardTitleEl.title = '–î–≤–∞–∂–¥—ã —â–µ–ª–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    boardTitleEl.addEventListener('dblclick', () => {
      openBoardDialog(board);
    });

    columnsEl.innerHTML = '';

    board.columns.forEach(column => {
      const colEl = document.createElement('div');
      colEl.className = 'column';
      colEl.dataset.columnId = column.id;
      colEl.draggable = true;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–∫–∏
      const headerEl = document.createElement('div');
      headerEl.className = 'column-header';
      
      const titleEl = document.createElement('h3');
      titleEl.textContent = column.name;
      
      const statsEl = document.createElement('div');
      statsEl.className = 'column-stats';
      const stats = getColumnStats(column);
      statsEl.innerHTML = `
        <span class="stats-done">${stats.done}</span>
        <span class="stats-separator">/</span>
        <span class="stats-total">${stats.total}</span>
      `;
      
      headerEl.appendChild(titleEl);
      headerEl.appendChild(statsEl);
      colEl.appendChild(headerEl);

      headerEl.addEventListener('dblclick', () => {
        openColumnDialog(column);
      });

      colEl.addEventListener('dragstart', (e) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—á–∞–ª–∏ —Ç–∞—â–∏—Ç—å –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏
        const header = colEl.querySelector('.column-header');
        if (!e.target.contains(header)) {
          e.preventDefault();
          return;
        }
        
        colEl.classList.add('dragging');
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞
        e.dataTransfer.setData('text/plain', colEl.dataset.columnId);
      });

      colEl.addEventListener('dragend', () => {
        colEl.classList.remove('dragging');
        removeAllDropIndicators();
      });
      
      // ================================
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Drag & Drop —Ç–∞—Å–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏
      // ================================
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–∞—Å–∫–∞ –Ω–∞–¥ –∫–æ–ª–æ–Ω–∫–æ–π
      colEl.addEventListener('dragover', (e) => {
        const draggingTask = document.querySelector('.task.dragging');
        const draggingCol = document.querySelector('.column.dragging');
        if (!draggingTask && !draggingCol) return;
        
        if (draggingTask) {
          showTaskDropIndicator(e, colEl, draggingTask);
        } else {
          // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É
          if (draggingCol === colEl) return;
          showColumnDropIndicator(e, draggingCol);
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è —Ç–∞—Å–∫–∞ –Ω–∞–¥ –∫–æ–ª–æ–Ω–∫–æ–π
      colEl.addEventListener('drop', (e) => {
        console.log('colEl drop: ', JSON.stringify(e));
        if (isProcessingDrop) return;

        const draggingTask = document.querySelector('.task.dragging');
        const draggingCol = document.querySelector('.column.dragging');
        if (!draggingTask && !draggingCol) return;

        e.preventDefault();
        e.stopPropagation();

        if (draggingTask) {
          handleTaskDrop(e, colEl);
        } else {
          handleColumnDrop(e);
        }
      });
      // ================================

      column.tasks
          .filter(task => !task.parentId) // –¢–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
          .forEach(task => renderTask(task, colEl));

      // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
      const addTaskBtn = document.createElement('button');
      addTaskBtn.className = 'add-btn';
      addTaskBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É';
      addTaskBtn.onclick = () => {
        openTaskDialog(column);
      };
      colEl.appendChild(addTaskBtn);

      columnsEl.appendChild(colEl);
    });
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
  function moveTaskToColumn(taskId, newColumnId, position = -1) {
    const board = getSelectedBoard();
    const task = findTaskById(taskId);
    
    if (!task) return;
    
    // –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞
    removeTaskFromCurrentPosition(task);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º parentId, —Ç–∞–∫ –∫–∞–∫ –∑–∞–¥–∞—á–∞ —Ç–µ–ø–µ—Ä—å –Ω–µ —Å–∞–±—Ç–∞—Å–∫
    task.parentId = null;
    
    // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
    const targetColumn = board.columns.find(col => col.id === newColumnId);
    if (!targetColumn) return;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –Ω—É–∂–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    if (position >= 0) {
      targetColumn.tasks.splice(position, 0, task);
    } else {
      targetColumn.tasks.push(task);
    }
    
    saveData();
    render();
  }

  addBoardBtn.addEventListener('click', () => {
    openBoardDialog();
  });

  addColumnBtn.addEventListener('click', () => {
    openColumnDialog();
  });

  function render() {
    renderBoardsList();
    renderBoard();
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (data.boards.length === 0) {
    // –°–æ–∑–¥–∞–¥–∏–º –æ–¥–Ω—É –¥–æ—Å–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultBoard = {
      id: generateId(),
      name: "–ú–æ—è –ø–µ—Ä–≤–∞—è –¥–æ—Å–∫–∞",
      columns: [{
        id: generateId(),
        name: "To Do",
        tasks: []
      }]
    };
    data.boards.push(defaultBoard);
    data.selectedBoardId = defaultBoard.id;
    saveData();
  }

  render();

  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞, –ø–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  const themeToggle = document.getElementById('theme-toggle');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-theme');
    themeToggle.textContent = '‚òÄÔ∏è';
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
    const isDark = document.body.classList.contains('dark-theme');
    themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–∞–ª–æ–≥–æ–º
  function openTaskDialog(column, existingTask = null) {
    const dialog = document.getElementById('task-dialog');
    const form = dialog.querySelector('form');
    const titleInput = document.getElementById('task-title');
    const descriptionInput = document.getElementById('task-description');
    const repeatCheckbox = document.getElementById('task-repeat');
    const infoCheckbox = document.getElementById('task-info'); // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    const resetTimeInput = document.getElementById('reset-time');
    const resetTimeGroup = document.querySelector('.reset-time-group');
    const submitButton = form.querySelector('button[type="submit"]');

    const taskColorsEl = document.getElementById('task-colors');
    const doneColorsEl = document.getElementById('done-colors');
    const doneColorGroup = document.getElementById('done-color-group');
    const customTaskColorInput = document.getElementById('custom-task-color');
    const customDoneColorInput = document.getElementById('custom-done-color');
    const resetTaskColorBtn = document.getElementById('reset-task-color');
    const resetDoneColorBtn = document.getElementById('reset-done-color');

    resetTaskColorBtn.addEventListener('click', () => {
      updateSelectedColor(taskColorsEl, null);
    });

    resetDoneColorBtn.addEventListener('click', () => {
      updateSelectedColor(doneColorsEl, null);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
    function updateSelectedColor(container, color) {
      container.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
        if (color && option.dataset.color === color) {
          option.classList.add('selected');
        }
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
    taskColorsEl.addEventListener('click', (e) => {
      const option = e.target.closest('.color-option');
      if (!option) return;
      
      const color = option.dataset.color;
      updateSelectedColor(taskColorsEl, color);
    });

    doneColorsEl.addEventListener('click', (e) => {
      const option = e.target.closest('.color-option');
      if (!option) return;
      
      const color = option.dataset.color;
      updateSelectedColor(doneColorsEl, color);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
    customTaskColorInput.addEventListener('input', (e) => {
      const color = e.target.value;
      e.target.closest('.color-option').dataset.color = color;
      updateSelectedColor(taskColorsEl, color);
    });

    customDoneColorInput.addEventListener('input', (e) => {
      const color = e.target.value;
      e.target.closest('.color-option').dataset.color = color;
      updateSelectedColor(doneColorsEl, color);
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    function updateColorGroups() {
      doneColorGroup.style.display = infoCheckbox.checked ? 'none' : 'block';
    }

    const board = getSelectedBoard();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º subtasks —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∏—Ö –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const existingSubtasks = existingTask ? existingTask.subtasks : [];

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
    const breadcrumbsEl = dialog.querySelector('.dialog-breadcrumbs');
    const titleEl = dialog.querySelector('h3');
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å
    let breadcrumbs = [board.name, column.name];
    
    if (existingTask && existingTask.parentId) {
      const parentPath = getTaskPath(existingTask);
      breadcrumbs = breadcrumbs.concat(parentPath);
    }
    
    breadcrumbsEl.textContent = breadcrumbs.join(' ‚Üí ');
    titleEl.textContent = existingTask ? existingTask.title : '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    submitButton.textContent = existingTask ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å';

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
    const handleRepeatChange = () => {
        resetTimeGroup.style.display = repeatCheckbox.checked ? 'block' : 'none';
        if (!repeatCheckbox.checked) {
            resetTimeInput.value = '';
        }
    };

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
    const handleInfoChange = () => {
        if (infoCheckbox.checked) {
          // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—Ç–∞–ª–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
            repeatCheckbox.checked = false;
            resetTimeGroup.style.display = 'none';
            resetTimeInput.value = '';
            // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º
            repeatCheckbox.closest('.form-group').style.display = 'none';
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            repeatCheckbox.closest('.form-group').style = '';
        }
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    repeatCheckbox.addEventListener('change', handleRepeatChange);
    infoCheckbox.addEventListener('change', handleInfoChange);
    infoCheckbox.addEventListener('change', updateColorGroups);
    
    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    const cleanup = () => {
        repeatCheckbox.removeEventListener('change', handleRepeatChange);
        infoCheckbox.removeEventListener('change', handleInfoChange);
        dialog.removeEventListener('close', cleanup);
    };
    
    dialog.addEventListener('close', cleanup);

    // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (existingTask) {
      titleInput.value = existingTask.title;
      descriptionInput.value = existingTask.description || '';
      infoCheckbox.checked = existingTask.isInfo || false;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
      if (existingTask.isInfo) {
        repeatCheckbox.closest('.form-group').style.display = 'none';
        repeatCheckbox.checked = false;
        resetTimeGroup.style.display = 'none';
        resetTimeInput.value = '';
      } else {
        repeatCheckbox.closest('.form-group').style = '';
        repeatCheckbox.checked = existingTask.repeating;
        resetTimeInput.value = existingTask.resetTime || '';
        resetTimeGroup.style.display = existingTask.repeating ? '' : 'none';
      }

      updateSelectedColor(taskColorsEl, existingTask.color || null);
      updateSelectedColor(doneColorsEl, existingTask.doneColor || null);
      updateColorGroups();
    } else {
      form.reset();
      resetTimeGroup.style.display = 'none';
      infoCheckbox.checked = false;
      repeatCheckbox.closest('.form-group').style = '';

      updateSelectedColor(taskColorsEl, null);
      updateSelectedColor(doneColorsEl, null);
      updateColorGroups();
    }

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = form.querySelector('.delete-btn');
    if (existingTask) {
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async () => {
        const confirmed = await showConfirmDialog(
          `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${existingTask.title}"?`
        );
        if (confirmed) {
          const taskIndex = column.tasks.findIndex(t => t.id === existingTask.id);
          if (taskIndex !== -1) {
            column.tasks.splice(taskIndex, 1);
            saveData();
            render();
            dialog.close();
          }
        }
      };
    } else {
      deleteBtn.style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.onsubmit = (e) => {
      e.preventDefault();

      const selectedTaskColor = taskColorsEl.querySelector('.color-option.selected')?.dataset.color;
      const selectedDoneColor = doneColorsEl.querySelector('.color-option.selected')?.dataset.color;

      
      const taskData = {
        id: existingTask ? existingTask.id : generateId(),
        title: titleInput.value.trim(),
        description: descriptionInput.value.trim(),
        // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
        done: infoCheckbox.checked ? false : (existingTask ? existingTask.done : false),
        doneDate: infoCheckbox.checked ? null : (existingTask ? existingTask.doneDate : null),
        repeating: infoCheckbox.checked ? false : repeatCheckbox.checked,
        resetTime: infoCheckbox.checked ? null : (repeatCheckbox.checked ? resetTimeInput.value || null : null),
        parentId: existingTask ? existingTask.parentId : null,
        subtasks: existingSubtasks,
        isInfo: infoCheckbox.checked,
        collapsed: existingTask ? existingTask.collapsed : false,
        color: selectedTaskColor,
        doneColor: infoCheckbox.checked ? null : selectedDoneColor,
      };

      if (existingTask) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É
        const taskIndex = column.tasks.findIndex(t => t.id === existingTask.id);
        if (taskIndex !== -1) {
          column.tasks[taskIndex] = taskData;
        }
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        column.tasks.push(taskData);
      }

      saveData();
      render();
      dialog.close();
    };

    dialog.showModal();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
  function formatTimeLeft(targetTime) {
    const now = new Date();
    const target = new Date();
    const [hours, minutes] = targetTime.split(':');
    target.setHours(hours, minutes, 0, 0);
    
    if (target <= now) {
      target.setDate(target.getDate() + 1);
    }
    
    const diff = target - now;
    const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
    const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    if (hoursLeft > 0) {
      return `‚Üª ${hoursLeft}—á ${minutesLeft}–º`;
    }
    return `‚Üª ${minutesLeft}–º`;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–±—Ä–æ—Å–∞ –∑–∞–¥–∞—á
  function checkTasksReset() {
    const now = new Date();
    let needsSave = false;

    data.boards.forEach(board => {
      board.columns.forEach(col => {
        col.tasks.forEach(task => {
          if (task.repeating && task.done && task.doneDate) {
            let shouldReset = false;

            if (task.resetTime) {
              // –ë–µ—Ä–µ–º –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ –Ω–µ–π –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞
              const doneDate = new Date(task.doneDate);
              const [hours, minutes] = task.resetTime.split(':');
              const resetTime = new Date(doneDate);
              resetTime.setHours(hours, minutes, 0, 0);
              
              // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è - –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
              if (resetTime <= doneDate) {
                resetTime.setDate(resetTime.getDate() + 1);
              }
              
              shouldReset = now >= resetTime;
            } else {
              // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ, —Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
              const doneDate = new Date(task.doneDate);
              const nextDay = new Date(doneDate);
              nextDay.setDate(nextDay.getDate() + 1);
              nextDay.setHours(0, 0, 0, 0);
              shouldReset = now >= nextDay;
            }

            if (shouldReset) {
              task.done = false;
              task.doneDate = null;
              needsSave = true;
              rerenderTask(task.id);
            }
          }
        });
      });
    });

    if (needsSave) {
      saveData();
    }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  checkTasksReset();
  setInterval(checkTasksReset, 1000);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–∞–ª–æ–≥–æ–º –∫–æ–ª–æ–Ω–∫–∏
  function openColumnDialog(existingColumn = null) {
    const dialog = document.getElementById('column-dialog');
    const form = dialog.querySelector('form');
    const nameInput = document.getElementById('column-name');
    const submitButton = form.querySelector('button[type="submit"]');
    const titleEl = dialog.querySelector('h3');
    const board = getSelectedBoard();
    
    if (!board) return;

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    titleEl.textContent = existingColumn ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É' : '–ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞';
    submitButton.textContent = existingColumn ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –æ—á–∏—â–∞–µ–º
    if (existingColumn) {
      nameInput.value = existingColumn.name;
    } else {
      form.reset();
    }

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = form.querySelector('.delete-btn');
    if (existingColumn) {
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async () => {
        const confirmed = await showConfirmDialog(
          `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É "${existingColumn.name}" —Å–æ –≤—Å–µ–º–∏ –∑–∞–¥–∞—á–∞–º–∏?`
        );
        if (confirmed) {
          const board = getSelectedBoard();
          const columnIndex = board.columns.findIndex(c => c.id === existingColumn.id);
          if (columnIndex !== -1) {
            board.columns.splice(columnIndex, 1);
            saveData();
            render();
            dialog.close();
          }
        }
      };
    } else {
      deleteBtn.style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.onsubmit = (e) => {
      e.preventDefault();
      
      const name = nameInput.value.trim();
      if (!name) return;

      if (existingColumn) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–ª–æ–Ω–∫—É
        existingColumn.name = name;
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
        board.columns.push({
          id: generateId(),
          name: name,
          tasks: []
        });
      }

      saveData();
      render();
      dialog.close();
    };

    dialog.showModal();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–∞–ª–æ–≥–æ–º –¥–æ—Å–∫–∏
  function openBoardDialog(existingBoard = null) {
    const dialog = document.getElementById('board-dialog');
    const form = dialog.querySelector('form');
    const nameInput = document.getElementById('board-name');
    const submitButton = form.querySelector('button[type="submit"]');
    const titleEl = dialog.querySelector('h3');

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    titleEl.textContent = existingBoard ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å–∫—É' : '–ù–æ–≤–∞—è –¥–æ—Å–∫–∞';
    submitButton.textContent = existingBoard ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–æ—Å–∫–∏ –∏–ª–∏ –æ—á–∏—â–∞–µ–º
    if (existingBoard) {
      nameInput.value = existingBoard.name;
    } else {
      form.reset();
    }

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = form.querySelector('.delete-btn');
    if (existingBoard) {
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async () => {
        const confirmed = await showConfirmDialog(
          `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ—Å–∫—É "${existingBoard.name}" —Å–æ –≤—Å–µ–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ –∏ –∑–∞–¥–∞—á–∞–º–∏?`
        );
        if (confirmed) {
          const boardIndex = data.boards.findIndex(b => b.id === existingBoard.id);
          if (boardIndex !== -1) {
            data.boards.splice(boardIndex, 1);
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å–∫—É –∏–ª–∏ –ø–µ—Ä–≤—É—é, –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é
            if (data.boards.length > 0) {
              data.selectedBoardId = data.boards[boardIndex]
                ? data.boards[boardIndex].id
                : data.boards[0].id;
            } else {
              data.selectedBoardId = null;
            }
            saveData();
            render();
            dialog.close();
          }
        }
      };
    } else {
      deleteBtn.style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.onsubmit = (e) => {
      e.preventDefault();
      
      const name = nameInput.value.trim();
      if (!name) return;

      if (existingBoard) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–æ—Å–∫—É
        existingBoard.name = name;
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –¥–æ—Å–∫—É
        const newBoard = {
          id: generateId(),
          name: name,
          columns: []
        };
        data.boards.push(newBoard);
        data.selectedBoardId = newBoard.id;
      }

      saveData();
      render();
      dialog.close();
    };

    dialog.showModal();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏
  function rerenderTask(taskId) {
    const taskEl = document.querySelector(`div[data-task-id="${taskId}"]`);
    if (!taskEl) return;

    // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É –≤ –¥–∞–Ω–Ω—ã—Ö
    let task = null;
    const board = getSelectedBoard();
    if (!board) return;

    board.columns.forEach(col => {
      const foundTask = col.tasks.find(t => t.id === taskId);
      if (foundTask) task = foundTask;
    });

    if (!task) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    taskEl.className = 'task' + (task.done ? ' done' : '');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å
    const checkbox = taskEl.querySelector('input[type="checkbox"]');
    if (checkbox) checkbox.checked = task.done;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ —Å–±—Ä–æ—Å–∞
    const resetInfo = taskEl.querySelector('.task-reset-info');
    if (resetInfo) resetInfo.remove();

    if (task.repeating && task.done) {
      const newResetInfo = document.createElement('div');
      newResetInfo.className = 'task-reset-info';
      
      if (task.resetTime) {
        newResetInfo.textContent = formatTimeLeft(task.resetTime);
      } else {
        newResetInfo.textContent = formatTimeLeft('00:00');
      }
      
      taskEl.appendChild(newResetInfo);
    }
  }

  function renderTask(task, container) {
    const taskEl = document.createElement('div');
    taskEl.className = 'task' + (task.done ? ' done' : '') + (task.parentId ? ' subtask' : '') + (task.isInfo ? ' info' : '');
    taskEl.draggable = true;
    taskEl.dataset.taskId = task.id;

    // –°–æ–∑–¥–∞–µ–º header –∑–∞–¥–∞—á–∏
    const taskHeader = document.createElement('div');
    taskHeader.className = 'task-header';

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞
    if (task.color || task.doneColor) {
      taskEl.style.borderLeftColor = task.done ? task.doneColor : task.color;
      taskEl.dataset.customColor = '';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–≤–µ—Ç–ª–µ–Ω–Ω—ã–π —Ñ–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç
      const bgColor = task.done && task.doneColor ? task.doneColor : task.color;
      const alpha = task.done ? '0.1' : '0.05';
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HEX –≤ RGB –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
      const rgb = hexToRGB(bgColor);
      
      if (!task.done) {
        taskEl.style.setProperty('--task-bg-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`);
      }
      
      if (task.done && task.doneColor) {
        const doneRgb = hexToRGB(task.doneColor);
        taskEl.style.setProperty('--task-done-bg-color', `rgba(${doneRgb.r}, ${doneRgb.g}, ${doneRgb.b}, 0.15)`);
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å
    if (!task.isInfo) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = task.done;
      checkbox.onclick = (e) => e.stopPropagation();
      checkbox.onchange = () => {
        task.done = checkbox.checked;
        if (checkbox.checked) {
          task.doneDate = new Date().toISOString();
        } else {
          task.doneDate = null;
        }
        saveData();
        render();
      };
      taskHeader.appendChild(checkbox);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞—á–∏
    const taskContent = document.createElement('div');
    taskContent.className = 'task-content';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.createElement('div');
    renderLinkedText(title, task.title, 'task-title');
    taskContent.appendChild(title);
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    if (task.description) {
      const descEl = document.createElement('div');
      renderLinkedText(descEl, task.description, 'task-description');
      taskContent.appendChild(descEl);
    }
    
    taskHeader.appendChild(taskContent);
    taskEl.appendChild(taskHeader);

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–±—Ä–æ—Å–µ
    if (task.repeating) {
      const repeatIcon = document.createElement('div');
      repeatIcon.className = 'task-repeat-icon';
      repeatIcon.innerHTML = 'üîÑ';
      repeatIcon.title = '–ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∑–∞–¥–∞—á–∞';
      taskEl.appendChild(repeatIcon);
    }

    container.appendChild(taskEl);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∞–±—Ç–∞—Å–∫–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (task.subtasks && task.subtasks.length > 0) {
      const subtasksContainer = document.createElement('div');
      subtasksContainer.className = 'subtasks-container';
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–π —Å–∞–±—Ç–∞—Å–∫ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      task.subtasks.forEach(subtaskId => {
        const subtask = findTaskById(subtaskId);
        if (subtask) {
          renderTask(subtask, subtasksContainer);
        }
      });
      
      taskEl.appendChild(subtasksContainer);
    }

    // –í —Ñ—É–Ω–∫—Ü–∏–∏ renderTask, –≥–¥–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏
    const timeIndicators = document.createElement('div');
    timeIndicators.className = 'task-time-indicators';

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    if (task.done && task.doneDate) {
      const doneTime = document.createElement('div');
      doneTime.className = 'task-done-time';
      doneTime.textContent = `‚úì ${formatDateTime(task.doneDate)}`;
      timeIndicators.appendChild(doneTime);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–±—Ä–æ—Å–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–¥–∞—á
    if (task.repeating && task.done) {
      const resetInfo = document.createElement('div');
      resetInfo.className = 'task-reset-info';

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
      if (resetTimeIntervals.has(task.id)) {
          clearInterval(resetTimeIntervals.get(task.id));
      }
      
      const updateTime = () => {
          resetInfo.textContent = formatTimeLeft(task.resetTime || '00:00');
      };
      
      updateTime(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
      const intervalId = setInterval(updateTime, 1000);
      resetTimeIntervals.set(task.id, intervalId);
      
      timeIndicators.appendChild(resetInfo);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    if (timeIndicators.children.length > 0) {
      taskEl.appendChild(timeIndicators);
    }

    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–∞–±—Ç–∞—Å–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    if (task.subtasks && task.subtasks.length > 0) {
      const expandToggle = document.createElement('div'); // –º–µ–Ω—è–µ–º span –Ω–∞ div
      expandToggle.className = 'task-expand-toggle';
      if (task.collapsed) {
        expandToggle.classList.add('collapsed');
      }
      
      expandToggle.onclick = (e) => {
        e.stopPropagation();
        const subtasksContainer = taskEl.querySelector('.subtasks-container');
        if (subtasksContainer) {
          const isExpanded = !expandToggle.classList.contains('collapsed');
          expandToggle.classList.toggle('collapsed');
          subtasksContainer.style.display = isExpanded ? 'none' : 'block';
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          task.collapsed = isExpanded;
          saveData();
        }
      };
      taskEl.appendChild(expandToggle);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–∞–±—Ç–∞—Å–∫–æ–≤
      const subtasksContainer = taskEl.querySelector('.subtasks-container');
      if (subtasksContainer && task.collapsed) {
        subtasksContainer.style.display = 'none';
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
    addTaskDragHandlers(taskEl);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  async function showConfirmDialog(message) {
    const dialog = document.getElementById('confirm-dialog');
    const messageEl = dialog.querySelector('#confirm-message');
    messageEl.textContent = message;
    
    dialog.showModal();
    
    return new Promise((resolve) => {
      dialog.addEventListener('close', () => {
        resolve(dialog.returnValue === 'confirm');
      }, { once: true });
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
  function formatDateTime(isoString) {
    const date = new Date(isoString);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
    const time = date.toLocaleTimeString('ru-RU', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞—Ç—É
    if (date.toDateString() === today.toDateString()) {
      return `—Å–µ–≥–æ–¥–Ω—è –≤ ${time}`;
    } else if (date.toDateString() === yesterday.toDateString()) {
      return `–≤—á–µ—Ä–∞ –≤ ${time}`;
    } else {
      return `${date.toLocaleDateString('ru-RU')} –≤ ${time}`;
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebar = document.getElementById('sidebar');

  // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞
  const backdrop = document.createElement('div');
  backdrop.className = 'sidebar-backdrop';
  document.body.appendChild(backdrop);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
  sidebarToggle.addEventListener('click', () => {
    document.body.classList.toggle('sidebar-open');
    sidebar.classList.toggle('open');
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—é
  backdrop.addEventListener('click', () => {
    document.body.classList.remove('sidebar-open');
    sidebar.classList.remove('open');
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–æ—Å–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  boardsEl.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
      document.body.classList.remove('sidebar-open');
      sidebar.classList.remove('open');
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏
  async function insertLink() {
    const dialog = document.getElementById('link-dialog');
    const form = dialog.querySelector('form');
    const urlInput = document.getElementById('link-url');
    const textInput = document.getElementById('link-text');
    const description = document.getElementById('task-description');

    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    form.reset();

    // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏
    const selectedText = description.value.substring(
      description.selectionStart,
      description.selectionEnd
    );
    if (selectedText) {
      textInput.value = selectedText;
    }

    dialog.showModal();

    // –ñ–¥–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞
    const closePromise = new Promise(resolve => {
      dialog.addEventListener('close', () => resolve(dialog.returnValue), { once: true });
    });

    form.onsubmit = (e) => {
      e.preventDefault();
      dialog.close('submit');
    };

    const result = await closePromise;
    if (result === 'submit') {
      const url = urlInput.value;
      const text = textInput.value || url;
      const link = `[${text}](${url})`;

      // –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ —Ç–µ–∫—Å—Ç
      const start = description.selectionStart;
      const end = description.selectionEnd;
      description.value = 
        description.value.substring(0, start) +
        link +
        description.value.substring(end);
    }
  }

  // –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞, –ø–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
  function formatDescription(text) {
    // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Markdown-—Å—Å—ã–ª–∫–∏ [text](url)
    let formatted = text.replace(
      /\[([^\]]+)\]\(([^)]+)\)/g,
      '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    
    // –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ URL, –∏—Å–∫–ª—é—á–∞—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤ —Ç–µ–≥–∞—Ö <a>
    formatted = formatted.replace(
      /(?<!["=])(https?:\/\/[^\s<]+)/g,
      '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    
    return formatted;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ —Å —Å—Å—ã–ª–∫–∞–º–∏
  function renderLinkedText(container, text, className = '') {
    container.className = className;
    container.innerHTML = formatDescription(text);
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∞–±—Ç–∞—Å–∫–∞–º–∏
  function findTaskById(taskId) {
    const board = getSelectedBoard();
    if (!board) {
      return null;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –∑–∞–¥–∞—á
    const allTasks = [];
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
    for (const column of board.columns) {
      for (const task of column.tasks) {
        allTasks.push(task);
        if (task.subtasks && task.subtasks.length > 0) {
          collectSubtasks(task, allTasks);
        }
      }
    }

    return allTasks.find(task => task.id === taskId);
  }

  function collectSubtasks(parentTask, tasksArray) {
    if (!parentTask.subtasks) return;
    
    for (const subtaskId of parentTask.subtasks) {
      // –ò—â–µ–º —Å–∞–±—Ç–∞—Å–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –º–∞—Å—Å–∏–≤–µ –∑–∞–¥–∞—á
      const subtask = tasksArray.find(t => t.id === subtaskId);
      if (subtask) {
        if (!tasksArray.includes(subtask)) {
          tasksArray.push(subtask);
        }
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–æ–±–∏—Ä–∞–µ–º —Å–∞–±—Ç–∞—Å–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–∞–±—Ç–∞—Å–∫–∞
        if (subtask.subtasks && subtask.subtasks.length > 0) {
          collectSubtasks(subtask, tasksArray);
        }
      }
    }
  }

  function makeSubtask(taskId, parentId) {
    const board = getSelectedBoard();
    if (!board) {
      return;
    }
    
    const task = findTaskById(taskId);
    const parentTask = findTaskById(parentId);
    if (!task || !parentTask) {
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if (isTaskAncestor(taskId, parentId)) {
      return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫—É —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–µ–π
    const parentColumn = board.columns.find(col => 
      col.tasks.some(t => t.id === parentId)
    );
    
    if (!parentColumn) {
      return;
    }
    
    // –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞
    removeTaskFromCurrentPosition(task);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
    task.parentId = parentId;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ subtasks –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!parentTask.subtasks) {
      parentTask.subtasks = [];
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º ID –∑–∞–¥–∞—á–∏ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–µ
    if (!parentTask.subtasks.includes(task.id)) {
      parentTask.subtasks.push(task.id);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ç—É –∂–µ –∫–æ–ª–æ–Ω–∫—É, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞
    const taskIndex = parentColumn.tasks.findIndex(t => t.id === parentId);
    if (taskIndex !== -1) {
      // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–∏
      parentColumn.tasks.splice(taskIndex + 1, 0, task);
    } else {
      // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
      parentColumn.tasks.push(task);
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é –¥–æ—Å–∫—É
    const boardIndex = data.boards.findIndex(b => b.id === board.id);
    if (boardIndex !== -1) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
      data.boards[boardIndex] = board;
    }

    saveData();
    render();
  }

  function isTaskAncestor(taskId, possibleAncestorId) {
    const task = findTaskById(taskId);
    if (!task || !task.parentId) return false;
    if (task.parentId === possibleAncestorId) return true;
    return isTaskAncestor(task.parentId, possibleAncestorId);
  }

  function removeTaskFromCurrentPosition(task) {
    if (!task) {
      return;
    }
    
    const board = getSelectedBoard();
    if (!board) {
      return;
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ —Å–∞–±—Ç–∞—Å–∫, —É–¥–∞–ª—è–µ–º –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—è
    if (task.parentId) {
      const parentTask = findTaskById(task.parentId);
      
      if (parentTask && parentTask.subtasks) {
        parentTask.subtasks = parentTask.subtasks.filter(id => id !== task.id);
      }
    }
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ–ª–æ–Ω–∫–∏
    for (const column of board.columns) {
      const index = column.tasks.findIndex(t => t.id === task.id);
      if (index !== -1) {
        column.tasks.splice(index, 1);
        break;
      }
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let isProcessingDrop = false;

  function addTaskDragHandlers(taskEl) {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    taskEl.addEventListener('dragstart', (e) => {
      e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–ª–∞—Å—å –∫–æ–ª–æ–Ω–∫–∞
      taskEl.classList.add('dragging');
    });

    taskEl.addEventListener('dragend', (e) => {
      e.stopPropagation();
      taskEl.classList.remove('dragging');
      removeAllDropIndicators();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ dragover —Å –ª–æ–≥–∏–∫–æ–π —Ç—Ä–µ—Ç–µ–π
    taskEl.addEventListener('dragover', (e) => {
      const draggingTask = document.querySelector('.task.dragging');
      if (!draggingTask) return;
      showTaskDropIndicator(e, taskEl, draggingTask);
    });

    taskEl.addEventListener('drop', (e) => {
      handleTaskDrop(e, taskEl);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    taskEl.addEventListener('dblclick', (e) => {
      e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
      
      const task = findTaskById(taskEl.dataset.taskId);
      if (task) {
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞–¥–∞—á–∞ (–∏–ª–∏ –µ—ë —Ä–æ–¥–∏—Ç–µ–ª—å, –µ—Å–ª–∏ —ç—Ç–æ —Å–∞–±—Ç–∞—Å–∫)
        const column = getSelectedBoard().columns.find(col => {
          return col.tasks.some(t => {
            if (t.id === task.id) return true; // –°–∞–º–∞ –∑–∞–¥–∞—á–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ
            return !!(task.parentId && t.id === task.parentId);
          });
        });
        
        if (column) {
          openTaskDialog(column, task);
        }
      }
    });
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ –¥–æ –∑–∞–¥–∞—á–∏
  function getTaskPath(task) {
    const path = [];
    let currentTask = task;
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—É—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –¥–æ –∫–æ—Ä–Ω–µ–≤–æ–π
    while (currentTask && currentTask.parentId) {
      const parentTask = findTaskById(currentTask.parentId);
      if (parentTask) {
        path.unshift(parentTask.title);
        currentTask = parentTask;
      } else {
        break;
      }
    }
    
    return path;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–ª–æ–Ω–∫–∏
  function getColumnStats(column) {
    let done = 0;
    let total = 0;

    function countTasks(tasks) {
      tasks.forEach(task => {
        if (!task.isInfo && task.parentId === null) { // –ù–µ —É—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
          total++;
          if (task.done) done++;
        }
      });
    }
    countTasks(column.tasks);
    return { done, total };
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
  function handleTaskDrop(e, container) {
    if (isProcessingDrop) return;

    const draggingTask = document.querySelector('.task.dragging');
    if (!draggingTask) return;

    e.preventDefault();
    e.stopPropagation();
    isProcessingDrop = true;

    try {
      const draggedTaskId = draggingTask.dataset.taskId;
      const board = getSelectedBoard();
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ —Ü–µ–ª–∏
      const isColumn = container.classList.contains('column');
      const targetTask = container.classList.contains('task') ? container : null;
      
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–æ–Ω–∫—É
      const colEl = isColumn ? container : container.closest('.column');
      const columnId = colEl.dataset.columnId;
      const column = board.columns.find(col => col.id === columnId);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
      const subtaskIndicator = targetTask?.querySelector('.subtask-drop-indicator');
      const taskIndicator = colEl.querySelector('.task-drop-indicator');
      const parentTaskEl = taskIndicator?.closest('.task');

      if (subtaskIndicator && targetTask) {
        // –°–ª—É—á–∞–π 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–±—Ç–∞—Å–∫–∞
        makeSubtask(draggedTaskId, targetTask.dataset.taskId);
      } else if (taskIndicator && parentTaskEl) {
        // –°–ª—É—á–∞–π 2: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞ —Å–∞–±—Ç–∞—Å–∫–æ–≤
        const draggedTask = findTaskById(draggedTaskId);
        const parentTask = findTaskById(parentTaskEl.dataset.taskId);
        const tasks = parentTask.subtasks;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤—Å—Ç–∞–≤–∫–∏
        const prevTask = taskIndicator.previousElementSibling;
        const nextTask = taskIndicator.nextElementSibling;
        const currentIndex = tasks.findIndex(task => task === draggedTaskId);
        const prevIndex = prevTask?.dataset ? tasks.findIndex(task => task === prevTask.dataset.taskId) : -1;
        const nextIndex = nextTask?.dataset ? tasks.findIndex(task => task === nextTask.dataset.taskId) : -1;

        if ((nextIndex === currentIndex || prevIndex === currentIndex) && currentIndex !== -1) return;

        let finalIndex = nextTask ? nextIndex : tasks.length;
        if (currentIndex !== -1) {
          finalIndex = currentIndex < finalIndex ? finalIndex - 1 : finalIndex;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
        removeTaskFromCurrentPosition(draggedTask);
        column.tasks.push(draggedTask);
        draggedTask.parentId = parentTask.id;
        parentTask.subtasks.splice(finalIndex, 0, draggedTaskId);

        saveData();
        render();
      } else if (taskIndicator) {
        // –°–ª—É—á–∞–π 3: –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫—É
        const tasks = column.tasks;

        // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –ø–æ–∑–∏—Ü–∏—é —Å—Ä–µ–¥–∏ –∑–∞–¥–∞—á
        const nextTask = taskIndicator.nextElementSibling;
        const prevTask = taskIndicator.previousElementSibling;
        let prevIndex = prevTask && prevTask.dataset ? tasks.findIndex(task => task.id === prevTask.dataset.taskId) : -1;
        let nextIndex = nextTask && nextTask.dataset ? tasks.findIndex(task => task.id === nextTask.dataset.taskId) : -1;
        let currentIndex = tasks.findIndex(task => task.id === draggingTask.dataset.taskId);

        // –ï—Å–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å —Ç–µ–∫—É—â–∏–º —Ç–∞—Å–∫–æ–º, —Ç–æ –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞–µ–º
        if ((nextIndex === currentIndex || prevIndex === currentIndex) && currentIndex !== -1) return;

        // —É—á–µ—Å—Ç—å, –µ—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π —Ç–∞—Å–∫ —É–∂–µ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
        let finalIndex = nextTask ? nextIndex : tasks.length;
        if (currentIndex !== -1) {
            finalIndex = currentIndex < finalIndex ? finalIndex - 1 : finalIndex;
        }
        
        moveTaskToColumn(draggedTaskId, columnId, finalIndex);
      }
    } finally {
      isProcessingDrop = false;
      removeAllDropIndicators();
    }
  }

  function handleColumnDrop(e) {
    if (isProcessingDrop) return;
    const draggingCol = document.querySelector('.column.dragging');
    if (!draggingCol) return;

    e.preventDefault();
    e.stopPropagation();
    isProcessingDrop = true;

    try {
      const board = getSelectedBoard();
      const draggedColId = draggingCol.dataset.columnId;
      const currentIndex = board.columns.findIndex(col => col.id === draggedColId);

      // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
      const indicator = document.querySelector('.column-drop-indicator');
      if (!indicator) return;

      const nextCol = indicator.nextElementSibling;
      const nextColIndex = nextCol ? board.columns.findIndex(col => col.id === nextCol.dataset.columnId) : -1;
      
      let finalIndex = nextCol ? nextColIndex : board.columns.length;
      if (currentIndex !== -1) {
        finalIndex = currentIndex < finalIndex ? finalIndex - 1 : finalIndex;
      }

      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
      if (finalIndex !== -1) {
        const [movedColumn] = board.columns.splice(currentIndex, 1);
        board.columns.splice(finalIndex, 0, movedColumn);
        saveData();
        render();
      }
    } finally {
      isProcessingDrop = false;
      removeAllDropIndicators();
    }
  }

  function showColumnDropIndicator(e, draggingCol) {
    e.preventDefault();
    e.stopPropagation();
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    removeAllDropIndicators();
    
    const indicator = document.createElement('div');
    indicator.className = 'column-drop-indicator';
    
    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –∫–æ–ª–æ–Ω–∫—É –∫ –∫—É—Ä—Å–æ—Ä—É
    const columns = Array.from(document.querySelectorAll('.column'));
    const mouseX = e.clientX;
    let closestColumn = null;
    let minDistance = Infinity;
    
    columns.forEach(col => {
      if (col === draggingCol) return;
      const rect = col.getBoundingClientRect();
      const colMiddle = rect.left + rect.width / 2;
      const distance = Math.abs(mouseX - colMiddle);
      
      if (distance < minDistance) {
        minDistance = distance;
        closestColumn = col;
      }
    });
    
    if (closestColumn) {
      const rect = closestColumn.getBoundingClientRect();
      if (mouseX < rect.left + rect.width / 2) {
        columnsEl.insertBefore(indicator, closestColumn);
      } else {
        columnsEl.insertBefore(indicator, closestColumn.nextSibling);
      }
    } else {
      columnsEl.appendChild(indicator);
    }
  }

  function showTaskDropIndicator(e, parentEl, draggingTask) {
    if (parentEl === draggingTask) return;
    e.preventDefault();
    e.stopPropagation();

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    removeAllDropIndicators();

    const indicator = document.createElement('div');
    indicator.className = 'task-drop-indicator';

    // –ï—Å–ª–∏ parentEl - —Ç–∞—Å–∫
    if (parentEl.classList.contains('task')) {
      const taskEl = parentEl;

      const taskRect = taskEl.getBoundingClientRect();
      const partHeight = taskRect.height / 4;
      const mouseY = e.clientY - taskRect.top;

      const subtasksContainer = taskEl.querySelector('.subtasks-container');
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∞–±—Ç–∞—Å–∫–æ–≤ - –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞–¥ –Ω–∏–º
      let aboveSubtasksContainer = false;
      if (subtasksContainer) {
        const subtasksContainerRect = subtasksContainer.getBoundingClientRect();
        if (e.clientY > subtasksContainerRect.top && e.clientY < subtasksContainerRect.bottom) {
          aboveSubtasksContainer = true;
        }
      }
      if (subtasksContainer && aboveSubtasksContainer) {
        // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤—Å—Ç–∞–≤–∫–∏
        const indicator = document.createElement('div');
        indicator.className = 'task-drop-indicator';
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –ø–æ–∑–∏—Ü–∏—é –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –∑–∞–¥–∞—á—É –∫ –∫—É—Ä—Å–æ—Ä—É
        let closestTask = null;
        let minDistance = Infinity;

        subtasksContainer.childNodes.forEach(node => {
          if (node.nodeType === 1) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —ç–ª–µ–º–µ–Ω—Ç
            const rect = node.getBoundingClientRect();
            const distance = Math.abs(e.clientY - rect.top);
            if (distance < minDistance) {
              closestTask = node;
              minDistance = distance;
            }
          }
        });

        if (closestTask) {
          subtasksContainer.insertBefore(indicator, closestTask);
        } else {
          subtasksContainer.appendChild(indicator);
        }
      } else if (mouseY > partHeight && mouseY < (partHeight * 3)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏
        // –ï—Å–ª–∏ —É –∑–∞–¥–∞—á–∏ –µ—â–µ –Ω–µ—Ç —Å–∞–±—Ç–∞—Å–∫–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–±—Ç–∞—Å–∫–∞
        const indicator = document.createElement('div');
        indicator.className = 'subtask-drop-indicator';
        taskEl.appendChild(indicator);
      } else {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const indicator = document.createElement('div');
        indicator.className = 'task-drop-indicator';

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (mouseY < partHeight) {
          taskEl.parentNode.insertBefore(indicator, taskEl);
        } else {
          taskEl.parentNode.insertBefore(indicator, taskEl.nextSibling);
        }
      }
    } else if (parentEl.classList.contains('column')) {
      const colEl = parentEl;
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –≤ –∫–æ–ª–æ–Ω–∫–µ
      const tasks = Array.from(colEl.querySelectorAll('.task:not(.subtask)'));
      const addTaskBtn = colEl.querySelector('.add-btn');

      // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–¥–∞—á, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π
      if (tasks.length === 0) {
        // –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        colEl.insertBefore(indicator, addTaskBtn);
        return;
      }

      // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –∑–∞–¥–∞—á—É –∫ –∫—É—Ä—Å–æ—Ä—É
      const mouseY = e.clientY;
      let closestTask = null;
      let minDistance = Infinity;

      tasks.forEach(task => {
        const rect = task.getBoundingClientRect();
        const taskMiddle = rect.top + rect.height / 2;
        const distance = Math.abs(mouseY - taskMiddle);

        if (distance < minDistance) {
          minDistance = distance;
          closestTask = task;
        }
      });

      if (closestTask) {
        const rect = closestTask.getBoundingClientRect();
        if (mouseY < rect.top + rect.height / 2) {
          colEl.insertBefore(indicator, closestTask);
        } else {
          colEl.insertBefore(indicator, closestTask.nextSibling);
        }
      } else {
        colEl.insertBefore(indicator, addTaskBtn);
      }
    }
  }

  function removeAllDropIndicators() {
    document.querySelectorAll('.subtask-drop-indicator').forEach(el => el.remove());
    document.querySelectorAll('.task-drop-indicator').forEach(el => el.remove());
    document.querySelectorAll('.column-drop-indicator').forEach(el => el.remove());
  }

  function hexToRGB(hex) {
    // –£–±–∏—Ä–∞–µ–º # –µ—Å–ª–∏ –µ—Å—Ç—å
    hex = hex.replace('#', '');
    
    // –ü–∞—Ä—Å–∏–º –∑–Ω–∞—á–µ–Ω–∏—è RGB
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    
    return { r, g, b };
  }

</script>

</body>
</html>
